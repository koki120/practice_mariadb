# 分析関数(ウィンドウ関数)

## ROW_NUMBER

先頭からの行番号を返す関数。OVER句で指定した並び順に対して適用される。PARTITION BYで適用する範囲を決める。PARTITION BYを省略した場合は全行が対象になる。

```sql
SELECT CONCAT(CustomerCode, ":", CustomerName),
    ROW_NUMBER() OVER (
        ORDER BY CustomerName
    ) AS 会社名昇順,
    ROW_NUMBER() OVER (
        ORDER BY CustomerCode
    ) AS 会社コード昇順
FROM Customers;
```
```bash
+-----------------------------------------+-----------------+-----------------------+
| CONCAT(CustomerCode, ":", CustomerName) | 会社名昇順      | 会社コード昇順        |
+-----------------------------------------+-----------------+-----------------------+
| C001:Acme Corporation                   |               1 |                     1 |
| C002:Beta Inc.                          |               2 |                     2 |
| C004:Delta Ltd.                         |               3 |                     4 |
| C005:Epsilon Industries                 |               4 |                     5 |
| C003:Gamma LLC                          |               5 |                     3 |
+-----------------------------------------+-----------------+-----------------------+
```
```sql
SELECT OrderNumber,
    Quantity,
    ROW_NUMBER() OVER (
        ORDER BY Quantity DESC
    ) AS 注文量の順位
FROM OrderDetails;
```
```bash
+-------------+----------+--------------------+
| OrderNumber | Quantity | 注文量の順位       |
+-------------+----------+--------------------+
| O004        |       30 |                  1 |
| O004        |       25 |                  2 |
| O003        |       20 |                  3 |
| O002        |       15 |                  4 |
| O005        |       12 |                  5 |
| O001        |       10 |                  6 |
| O005        |        8 |                  7 |
| O002        |        7 |                  8 |
| O001        |        5 |                  9 |
| O003        |        3 |                 10 |
+-------------+----------+--------------------+
```
```sql
SELECT OrderNumber,
    Quantity,
    ROW_NUMBER() OVER (
        PARTITION BY OrderNumber
        ORDER BY Quantity DESC
    ) AS 注文量の順位
FROM OrderDetails;
```
```bash 
+-------------+----------+--------------------+
| OrderNumber | Quantity | 注文量の順位       |
+-------------+----------+--------------------+
| O001        |       10 |                  1 |
| O001        |        5 |                  2 |
| O002        |       15 |                  1 |
| O002        |        7 |                  2 |
| O003        |       20 |                  1 |
| O003        |        3 |                  2 |
| O004        |       30 |                  1 |
| O004        |       25 |                  2 |
| O005        |       12 |                  1 |
| O005        |        8 |                  2 |
+-------------+----------+--------------------+
```

## LAG

指定した列の指定したn行前の値を取得する。引数の１番目に列名、2番目に何番目かを指定する。

```sql
WITH DailyTotals AS (
    SELECT 
        O.OrderDate,
        SUM(OD.Quantity) AS TotalQuantity
    FROM 
        OrderDetails OD
    JOIN 
        Orders O ON OD.OrderNumber = O.OrderNumber
    GROUP BY 
        O.OrderDate
    ORDER BY
    OrderDate
)
SELECT
    OrderDate,
    TotalQuantity,
    TotalQuantity - LAG(TotalQuantity, 1) OVER (ORDER BY OrderDate) AS 前日比
FROM
    DailyTotals;
```
```bash
+------------+---------------+-----------------------+
| OrderDate  | TotalQuantity | 前日からの増減        |
+------------+---------------+-----------------------+
| 2024-08-27 |            15 |                  NULL |
| 2024-08-28 |            22 |                     7 |
| 2024-08-29 |            23 |                     1 |
| 2024-08-30 |            55 |                    32 |
| 2024-08-31 |            20 |                   -35 |
+------------+---------------+-----------------------+
```